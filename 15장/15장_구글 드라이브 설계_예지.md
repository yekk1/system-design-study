# 핵심개념

## 구글 드라이브란?

- 파일 저장 및 동기화 서비스
    1. 문서, 사진, 비디오, 기타 파일을 클라우드에 보관
    2. 컴퓨터, 스마트폰, 태블릿 등 다양한 단말에서 이용 가능
    3. 파일 공유 기능

---

## 1. 문제 이해 및 설계 범위 확정

- 중요 지원 기능? ⇒ 파일 업로드/다운로드, 파일 동기화, 알림
    - ⇒ 여러 단말에 파일 동기화, 파일 갱신 이력 조회
    - ⇒ 파일 공유
    - ⇒ 파일 편집/삭제/새로운 공유 시 알림 표시
- 지원 범위 ⇒ 모바일 앱 / 웹 앱
- 파일 암호화
- 파일 크기 제한: 10GB
- 사용자: 천만 DAU
    - 매일 각 사용자가 평균 2개 파일 업로드 가정
    - 읽기:쓰기 비율 = 1:1
    - 필요 저장공간 총량: 5천만 사용자 * 10GB = 500PB
    - 업로드 API QPS = ( 2 * 천만 ) / 24시간 / 3600초 = 약 240
    - 최대 QPS = 2 * QPS = 480
- 안전성 / 빠른 동기화 속도 / 네트워크 대역폭절약 / 규모 확장성 / 높은 가용성

## 개략적 설계안 및 제시 구하기

점진적 설계

### 1. 하나의 웹 서버로 시작

- 웹 서버 / 데이터 베이스 / 1TB의 저장소 시스템

```java
## 디렉터리 구조
/drive
	/user1
		recipes
		chiken_soup.txt
	/user2
		hanghae99_w01.mp4
	/user3
		system-design-study_ch15.md
```

### 2. API

- 파일 업로드 API
    - 단순 업로드
    - 이어 올리기
        - https://api.example.com/files/upload?uploadType=resumble
    
    ```java
    ##prameter
    uploadType=resumble
    data: 업로드할 로컬 파일
    ```
    
- 파일 다운로드 API
    - https://api.example.com/files/download
    
    ```java
    ##parameter
    {
    	"path" : "/recipes/soup/best_soup.txt"
    }
    ```
    
- 파일 갱신 히스토리 API
    - https://api.example.com/files/list_revisions
    
    ```java
    ##parameter
    {
    	"path": "/recipes/soup/best_soup.txt",
    	"limit": 20
    }
    ```
    

### 3. 한 대 서버의 제약 극복

- 샤딩
    - user_id%4
- 아마존 S3 (Simple Storage Service) - 파일저장소
    - 업계 최고 수준의 규모 확장성 /가용성/보안 성능
    - 다중화 지원
        - 동일 지역 내 다중 화 / 여러지역에 걸친 다중화
- 로드밸런서
    - 비교적 더 자유로운 웹서버 추가
- 메타데이터 데이터베이스 ↔ 파일 저장 서버와 분리
    - SPOF 회피

### 4. 동기화 충돌

- 두 명 이상의 사용자가 같은 파일/폴더에 동시 업데이트
    - 첫 변경 요청: 동기화 성공
    - 이후 변경 요청: 충돌 발생

```java
system-design-study_ch15.md
! system-design-study_ch15.md_user2_conflicted_copy_2025-10-30
```

### 5. 개략적 설계안

![image.png](attachment:e35ca174-f41e-43a3-a330-3456f1a74fcf:image.png)

- 사용자 단말 (웹브라우저, 클라이언트)
- 블록 저장소 서버
    - 파일을 여러개의 블록으로 저장. 각 블록에 고유 해시값 할당
    - 해시값: 메타데이터DB에 저장
    - 다운로드 시 블록을 재결합
- 클라우드 저장소
    - 블록 단위로 나뉘어진 파일을 보관
- 아카이빙 저장소
    - 비활성 데이터 저장
- 로드밸런서
- API서버
    - 사용자 인증, 사용자 프로파일 관리, 메타데이터 갱신
- 메타데이터DB
    - 사용자, 파일, 블록, 버전
- 메타데이터 캐시
- 알림 서비스
    - 발생/구독 프로토콜 기반 시스템
    - 파일 최신상태 알림
- 오프라인 사용자 백업 큐
    - 클라이언트가 접속할 시에 최신 상태 동기화

## 3. 상세 설계

### 블록 저장소 서버

- 델타 동기화
    - 수정이 일어난 블록만 동기화
- 압축
    - 블록 단위로 압축
- 블록 저장소 서버의 흐름
    - 파일 ⇒ 블록 분할 ⇒ 압축 ⇒ 암호화 ⇒ (수정된 블록만) 클라우드 저장소에 업로드

### 높은 일관선 요구 사항

- 강한 일관성 모델 지원
    - 캐시에 보관 된 사본 - 데이터베이스 원본 일치
    - 데이터베이스 원본의 변겨 발생 ⇒ 즉시 캐시 사본 무효화
- RDBMS: ACID 지원 → 강한 일관성 보장 쉬움
- NoSQL → 동기화 로직 안에 프로그래밍 필요

### 메타데이터 DB

![image.png](attachment:794bb1d7-9d4e-4593-848c-4b384b7de5b9:image.png)

### 업로드 절차

![image.png](attachment:48c07637-bca2-49cb-a3af-373627d8bccd:image.png)

### 다운로드 절차

![image.png](attachment:7c8a2533-5f8c-4efe-8b21-f9f3203e48c8:image.png)

### 알림 서비스

- 롱 폴링
    - 클라이언트 ↔ 알림서버 롱 폴링용 변경 유지
    - 특정 파일에 대한 변경 감지 → 연결 끊음 & 최신 파일 다운로드
    - 롱 폴링 연결 복원
- 웹 소켓

### 파일 저장소 공간 절약

- 중복 제거
- 지능적 백업 전략
    - 보관 파일 버전 개수 상한 **한도설정**
    - 중요한 버전만 보관
- 아카이빙 저장소

### 장애 처리 흐름

- 로드밸런서 장애
- 블록 저장소 서버 장애
- 클라우드 저장소 장애
- API 서버 장애
- 메타데이터 캐시 장애
- 메타데이터 DB 장애
- 알림 서비스 장애
- 오프라인 사용자 백업 큐 장애
